<template>
  <BaseBreadcrumb :title="page.title" :breadcrumbs="breadcrumbs" />
  <UiParentCard>
    <!-- 상단 버튼 -->
    <v-row justify="end" class="mb-2">
      <v-btn color="error" class="top_btn_ser" variant="elevated" @click="resetForm">초기화</v-btn>
      <v-btn color="primary" class="top_btn_ser" @click="saveForm">등록</v-btn>
    </v-row>
    <!-- 라디오 -->
    <div class="radios">
      <label class="radio"> <input type="radio" value="완반제품" v-model="search.type" /> 완/반제품 </label>
      <label class="radio"> <input type="radio" value="원목" v-model="search.type" /> 원목 </label>
      <label class="radio"> <input type="radio" value="합판" v-model="search.type" /> 합판 </label>
    </div>

    <!-- 상단 그리드: 카테고리 목록 -->
    <div class="grid-wrap">
      <ag-grid-vue
        :theme="quartz"
        style="height: 420px; width: 100%"
        :columnDefs="colDefs"
        :rowData="rows"
        :gridOptions="mainGridOptions"
        rowSelection="single"
        @grid-ready="onMainGridReady"
        @selection-changed="onMainSelectionChanged"
        @cell-value-changed="onCellValueChanged"
      />
    </div>
    <br />
    <!-- 하단 그리드: 선택행 1건 -->
    <div class="grid-wrap" style="margin-top: 12px">
      <ag-grid-vue
        :theme="quartz"
        style="height: 200px; width: 100%"
        :columnDefs="colDefs"
        :rowData="detailRows"
        :gridOptions="detailGridOptions"
      />
    </div>
  </UiParentCard>
</template>

<script setup>
import { ref, shallowRef, computed, watch } from 'vue';
import BaseBreadcrumb from '@/components/shared/BaseBreadcrumb.vue';
import UiParentCard from '@/components/shared/UiParentCard.vue';
import { AgGridVue } from 'ag-grid-vue3';
import { AllCommunityModule, ModuleRegistry, themeQuartz } from 'ag-grid-community';

ModuleRegistry.registerModules([AllCommunityModule]);
const quartz = themeQuartz;

const page = ref({ title: '품질 기준 관리' });
const breadcrumbs = shallowRef([
  { title: '품질', disabled: true, href: '#' },
  { title: '품질 기준 관리', disabled: false, href: '#' }
]);

// 컬럼
const colDefs = ref([
  { headerName: '기준', field: '기준', flex: 0.9 },
  { headerName: '검사내용', field: '검사내용', flex: 1.4 },
  { headerName: '허용수치', field: '허용수치', flex: 1.3 }
]);

// ✅ 카테고리별 데이터 맵(객체) — rowData에 직접 넣지 말고 computed로 골라서 넣음
const dataMap = ref({
  완반제품: [
    { 기준: '함수율', 검사내용: '수분 함량 검사', 허용수치: '수분 함량이 12 ~ 13% 이하' },
    { 기준: '치수정밀도', 검사내용: '전체 외형치수, 가공 및 조립 후 치수', 허용수치: '입고자재에서 ± 2mm 이내' },
    { 기준: '강도/내구성', 검사내용: '하중, 휨, 낙하, 반복 사용시험(횡강도, 압축)', 허용수치: '횡강도 35MPa 이상' },
    {
      기준: '안정성',
      검사내용: '전도방지, 전기부 위험, 모서리 안전성 시험',
      허용수치: '전도 없음, 전기부 안전, 모서리 둥글림 위험요소 없음'
    },
    { 기준: '외관 결정', 검사내용: '옹이, 훼절, 균열 등 외관', 허용수치: '옹이, 훼절, 균열 유약확인 시 결점이 없을 시' },
    { 기준: '포름알데히드 방출량', 검사내용: '완/반제품 목재의 포름알데히드 방출 시험', 허용수치: '친환경 E0 등급(0.3mg/L)이하' },
    { 기준: '표면 마감/도장', 검사내용: '도막 균일성, 접착력, 내마모성 검사', 허용수치: '도막 들뜸·박리 없음, 균일한 색상·광택 유지' }
  ],
  원목: [
    { 기준: '함수율', 검사내용: '수분 함량 검사', 허용수치: '10 ~ 12% 이하' },
    { 기준: '치수정밀도', 검사내용: '가공 치수 오차 측정', 허용수치: '± 1.5mm 이내' },
    { 기준: '외관', 검사내용: '옹이/균열/뒤틀림', 허용수치: '구조적 강성 저하 없음' }
  ],
  합판: [
    { 기준: '겉면 등급', 검사내용: '옹이, 패치, 크랙', 허용수치: '등급 기준 충족(BB/CC 등)' },
    { 기준: '접착 강도', 검사내용: '박리 시험', 허용수치: '기준 이상' },
    { 기준: '포름알데히드', 검사내용: '방출량 시험', 허용수치: 'E0 등급(0.3mg/L)이하' }
  ]
});

// ✅ 라디오 상태 (초기값을 반드시 유효 키로)
const search = ref({ type: '완반제품' });

// ✅ 라디오 선택에 따른 현재 행들
const rows = computed(() => dataMap.value[search.value.type] ?? []);

// 메인 그리드 옵션/API
const mainGridOptions = ref({
  defaultColDef: { resizable: true, sortable: true },
  pagination: false
});
let mainApi = null;
const onMainGridReady = (e) => {
  mainApi = e.api;
  e.api.setGridOption('rowData', rows.value);
  // 첫 행 자동 선택
  setTimeout(() => {
    e.api.ensureIndexVisible(0);
    e.api.selectIndex(0);
  }, 0);
};

// 라디오 변경 시 메인 그리드 갱신
watch(rows, (v) => {
  if (mainApi) mainApi.setGridOption('rowData', v);
});

// 선택 행 → 하단 단건 변경 그리드에 반영
const selectedRow = ref(null);
const onMainSelectionChanged = (e) => {
  selectedRow.value = (e.api.getSelectedRows?.() || [])[0] || null;
};
const detailRows = computed(() => (selectedRow.value ? [selectedRow.value] : []));

// 하단 그리드 옵션(여기선 편집 가능하게)
const detailGridOptions = ref({
  defaultColDef: { resizable: true, editable: true },
  pagination: false
});

const onCellValueChanged = (p) => {
  console.log(onCellValueChanged(p));
};

// 상단 버튼
function resetForm() {
  alert('데이터 초기화');
}
</script>

<style scoped>
.radios {
  display: flex;
  gap: 16px;
  margin: 8px 0 12px;
}
.radio {
  display: flex;
  align-items: center;
  gap: 6px;
}
.grid-wrap {
  border: 1px solid #e5e5e5;
  border-radius: 10px;
  overflow: hidden;
}
.top_btn_ser {
  margin-right: 10px;
}
</style>
